/* zhitiao.94uv.com 2014-10-28 */
function Dialog(a){var b=this,c=b.options=$.extend({title:"提示",width:450,skin:"",ico:""},a),d=b.main=$("<div/>").addClass("popup").addClass("popup-"+c.skin),e=($("<div/>").addClass("popup-title").text(c.title).appendTo(d),$('<a href="javascript:;"><i class="fa fa-times"></i></a>').addClass("close").appendTo(d)),f=$("<div/>").addClass("popup-content").appendTo(d),g=($("<i/>").addClass("popup-ico").addClass(c.ico).appendTo(f),$("<div/>").addClass("popup-text").text(c.content).appendTo(f),b.footer=$("<div/>").addClass("popup-btn").hide().appendTo(d));if(c.buttons&&c.buttons.length&&(g.show(),b.renderBtns(c.buttons)),d.appendTo($(document.body)),c.modal){var h=b.mask=$("<div/>").addClass("mask");$(document.body).append(h),h.on("click",function(){b.hide()})}e.on("click",function(){b.hide()}),b.show()}Dialog.prototype={constructor:Dialog,show:function(){var a=this.main;this.options.modal&&this.mask.css({width:$(window).width()+"px",height:Math.max($(window).height(),$(document.body).outerHeight())+"px"}).show(),a.width(this.options.width).show();var b=($(window).height()-a.outerHeight())/2,c=($(window).width()-a.outerWidth())/2,d=$(window).scrollTop();a.css({left:c+"px",top:b+d+"px"})},hide:function(){this.mask&&this.mask.hide(),this.main.hide()},dispose:function(){this.mask&&this.mask.hide().remove(),this.main.hide().remove(),this.mask=this.main=this.foot=null},renderBtns:function(a){var b=this,c=b.footer;$.each(a,function(a,d){var e=$('<button type="button" />').text(d.text).addClass("btn btn-"+(d.skin||"default")).appendTo(c);e.on("click",function(){d.handler&&d.handler.call(b)})})}};var util=function(){function a(a,b){var c=$("#popup-"+a);if(!c.size())return!1;c.show(),b=$.extend({},b);var d=($(window).height()-c.outerHeight())/2,e=($(window).width()-c.outerWidth())/2;if(c.css({left:e+"px",top:d+"px"}),b.width>0&&c.css("width",b.width+"px"),b.modal){var f=$("<div/>").addClass("mask").css({width:$(window).width()+"px",height:Math.max($(window).height(),$(document.body).outerHeight())+"px"});$(document.body).append(f),f.show(),f.on("click",function(){var a=$(this);c.hide(),a.hide().remove()})}}var b={};b.lang={index:{talkDel:"确认要删除与 #{0} 的对话记录吗？",userBan:"确认要将 #{0} 加入屏蔽用户列表吗？您将收不到对方发来的纸条",markread:"您确定要将所有消息的状态置为已读吗？"},message:{batchDel:"确认要删除这些对话记录吗？"},talk:{userBan:"确认要将 #{0} 加入屏蔽用户列表吗？您将收不到对方发来的纸条"}};var c={confirm:"fa fa-question-circle"};return b.confirm=function(a){var b=$.extend({title:"确认",width:450,fontawesome:1,cancelBtnText:"取消",okBtnText:"确认",skin:"confirm",ico:c.confirm,buttons:[{text:"取消",handler:function(){this.hide()}},{text:"确定",skin:"primary",handler:function(){var b;a.okHandler&&(b=a.okHandler.call(this)),b!==!1&&this.hide()}}]},a),d=new Dialog(b);return d},b.showPopup=a,b.format=function(a,b){a=String(a);var c=Array.prototype.slice.call(arguments,1),d=Object.prototype.toString;return c.length?(c=1==c.length&&null!==b&&/\[object Array\]|\[object Object\]/.test(d.call(b))?b:c,a.replace(/#\{(.+?)\}/g,function(a,b){var e=c[b];return"[object Function]"==d.call(e)&&(e=e(b)),"undefined"==typeof e?"":e})):a},b.parseJSON=function(a){try{return new Function("return ("+a+")")()}catch(b){return{}}},b}();!function(a){var b=new Array,c=new Array;a.fn.doAutosize=function(b){var c=a(this).data("minwidth"),d=a(this).data("maxwidth"),e="",f=a(this),g=a("#"+a(this).data("tester-id"));if(e!==(e=f.val())){var h=e.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");g.html(h);var i=g.width(),j=i+b.comfortZone>=c?i+b.comfortZone:c,k=f.width(),l=k>j&&j>=c||j>c&&d>j;l&&f.width(j)}},a.fn.resetAutosize=function(b){var c=a(this).data("minwidth")||b.minInputWidth||a(this).width(),d=a(this).data("maxwidth")||b.maxInputWidth||a(this).closest(".tagsinput").width()-b.inputPadding,e=a(this),f=a("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),fontWeight:e.css("fontWeight"),letterSpacing:e.css("letterSpacing"),whiteSpace:"nowrap"}),g=a(this).attr("id")+"-autosize-tester";!a("#"+g).length>0&&(f.attr("id",g),f.appendTo("body")),e.data("minwidth",c),e.data("maxwidth",d),e.data("tester-id",g),e.css("width",c)},a.fn.addTag=function(d,e){return e=jQuery.extend({focus:!1,callback:!0},e),this.each(function(){var f=a(this).attr("id"),g=a(this).val().split(b[f]);if(""==g[0]&&(g=new Array),d=jQuery.trim(d),e.unique){var h=a(g).tagExist(d);1==h&&a("#"+f+"-tag").addClass("taginputs-not-valid")}else var h=!1;if(""!=d&&1!=h){if(a("<span>").addClass("tag").append(a("<span>").text(d).append("&nbsp;&nbsp;"),a("<a>",{href:"#",title:"删除",text:"x"}).click(function(){return a("#"+f).removeTag(escape(d))})).insertBefore("#"+f+"-addTag"),g.push(d),a("#"+f+"-tag").val(""),e.focus?a("#"+f+"-tag").focus():a("#"+f+"-tag").blur(),a.fn.tagsInput.updateTagsField(this,g),e.callback&&c[f]&&c[f].onAddTag){var i=c[f].onAddTag;i.call(this,d)}if(c[f]&&c[f].onChange){var j=g.length,i=c[f].onChange;i.call(this,a(this),g[j-1])}}}),!1},a.fn.removeTag=function(d){return d=unescape(d),this.each(function(){var e=a(this).attr("id"),f=a(this).val().split(b[e]);for(a("#"+e+"-tagsinput .tag").remove(),str="",i=0;i<f.length;i++)f[i]!=d&&(str=str+b[e]+f[i]);if(a.fn.tagsInput.importTags(this,str),c[e]&&c[e].onRemoveTag){var g=c[e].onRemoveTag;g.call(this,d)}}),!1},a.fn.tagExist=function(b){return jQuery.inArray(b,a(this))>=0},a.fn.importTags=function(b){id=a(this).attr("id"),a("#"+id+"-tagsinput .tag").remove(),a.fn.tagsInput.importTags(this,b)},a.fn.tagsInput=function(d){var e=jQuery.extend({interactive:!0,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:!1},hide:!0,delimiter:",",unique:!0,removeWithBackspace:!0,placeholderColor:"#666666",autosize:!0,comfortZone:20,inputPadding:12},d);return this.each(function(){e.hide&&a(this).hide();var d=a(this).attr("id"),f=jQuery.extend({pid:d,realInput:"#"+d,holder:"#"+d+"-tagsinput",inputWrapper:"#"+d+"-addTag",fakeInput:"#"+d+"-tag"},e);b[d]=f.delimiter,(e.onAddTag||e.onRemoveTag||e.onChange)&&(c[d]=new Array,c[d].onAddTag=e.onAddTag,c[d].onRemoveTag=e.onRemoveTag,c[d].onChange=e.onChange);var g='<div id="'+d+'-tagsinput" class="tagsinput"><div id="'+d+'-addTag">';if(e.interactive&&(g=g+'<input id="'+d+'-tag" value="" data-default="'+e.defaultText+'" />'),g+='</div><div class="tags-clear"></div></div>',a(g).insertAfter(this),a(f.holder).css("width",e.width),a(f.holder).css("height",e.height),""!=a(f.realInput).val()&&a.fn.tagsInput.importTags(a(f.realInput),a(f.realInput).val()),e.interactive){if(a(f.fakeInput).val(a(f.fakeInput).attr("data-default")),a(f.fakeInput).css("color",e.placeholderColor),a(f.fakeInput).resetAutosize(e),a(f.holder).bind("click",f,function(b){a(b.data.fakeInput).focus()}),a(f.fakeInput).bind("focus",f,function(b){a(b.data.holder).addClass("tagsinput-focus"),a(b.data.fakeInput).val()==a(b.data.fakeInput).attr("data-default")&&a(b.data.fakeInput).val(""),a(b.data.fakeInput).css("color","#000000")}),a(f.fakeInput).bind("blur",f,function(b){a(b.data.holder).removeClass("tagsinput-focus")}),void 0!=e.autocompleteUrl){var h={source:e.autocompleteUrl};for(attrname in e.autocomplete)h[attrname]=e.autocomplete[attrname];void 0!==jQuery.Autocompleter?(a(f.fakeInput).autocomplete(e.autocompleteUrl,e.autocomplete),a(f.fakeInput).bind("result",f,function(b,c){c&&a("#"+d).addTag(c[0]+"",{focus:!0,unique:e.unique})})):void 0!==jQuery.ui.autocomplete&&(a(f.fakeInput).autocomplete(h),a(f.fakeInput).bind("autocompleteselect",f,function(b,c){return a(b.data.realInput).addTag(c.item.value,{focus:!0,unique:e.unique}),!1}),a(f.fakeInput).bind("focusin",f,function(b){a(b.data.fakeInput).autocomplete("search",a(b.data.fakeInput).val())}))}else a(f.fakeInput).bind("blur",f,function(b){var c=a(this).attr("data-default"),d=a(b.data.fakeInput);return""!=d.val()&&d.val()!=c?b.data.minChars<=d.val().length&&(!b.data.maxChars||b.data.maxChars>=d.val().length)&&a(b.data.realInput).addTag(d.val(),{focus:!0,unique:e.unique}):(d.val(d.attr("data-default")),d.css("color",e.placeholderColor)),!1});a(f.fakeInput).bind("keydown",f,function(b){return 188==b.which||186==b.which||13==b.which?(b.preventDefault(),b.data.minChars<=a(b.data.fakeInput).val().length&&(!b.data.maxChars||b.data.maxChars>=a(b.data.fakeInput).val().length)&&a(b.data.realInput).addTag(a(b.data.fakeInput).val(),{focus:!0,unique:e.unique}),a(b.data.fakeInput).resetAutosize(e),!1):void(b.data.autosize&&a(b.data.fakeInput).doAutosize(e))}),f.removeWithBackspace&&a(f.fakeInput).bind("keydown",function(b){if(8==b.keyCode&&""==a(this).val()){b.preventDefault();var c=a(this).closest(".tagsinput").find(".tag:last").text(),d=a(this).attr("id").replace(/-tag$/,"");c=c.replace(/[\s]+x$/,""),a("#"+d).removeTag(escape(c)),a(this).trigger("focus")}}),a(f.fakeInput).blur(),f.unique&&a(f.fakeInput).keydown(function(b){(8==b.keyCode||188==b.keyCode||186==b.keyCode||String.fromCharCode(b.which).match(/\w+|[áéíóúÁÉÍÓÚñÑ,/]+/))&&a(this).removeClass("taginputs-not-valid")})}return!1}),this},a.fn.tagsInput.updateTagsField=function(c,d){var e=a(c).attr("id");a(c).val(d.join(b[e]))},a.fn.tagsInput.importTags=function(d,e){a(d).val("");var f=a(d).attr("id"),g=e.split(b[f]);for(i=0;i<g.length;i++)a(d).addTag(g[i],{focus:!1,callback:!1});if(c[f]&&c[f].onChange){var h=c[f].onChange;h.call(d,d,g[i])}}}(jQuery);var util=window.util||{},pageParams=window.pageParams||{};$(function(){$(".uc-redirect-add").each(function(a,b){var c=encodeURIComponent(window.location.href),d=$(b).attr("href");d+=(d.indexOf("?")>-1?"&":"?")+"redirect_url="+c,$(b).attr("href",d)}),$(".weixin").on("mouseover",function(){$(this).children("div").show()}).on("mouseout",function(){$(this).children("div").hide()});var a=$("#scrolltop");$(window).on("scroll",function(){var b=$(window).scrollTop();b>80?a.show():a.hide()}),a.on("click",function(){$(document.body).animate({scrollTop:0},"fast")});var b,c=$(".main"),d=(c.height(),$(".side .appl")),e=d.offset().top+d.outerHeight();$(window).on("scroll",function(){var a=$(window).scrollTop();a>e?(b&&clearTimeout(b),b=setTimeout(function(){var a=$(window).scrollTop();a>e&&d.addClass("fixed")},500)):d.removeClass("fixed")})}),$(function(){function a(a,b){var c,d=a.attr("data-value")||"{}",e=util.parseJSON(d);"talkdel"==b&&(c=pageParams.ajaxUrl.banUser,util.confirm({modal:1,content:util.format(util.lang.index.talkDel,e.username),okHandler:function(){$.post(c,e,function(){window.location.reload()})}})),"userban"==b&&(c=pageParams.ajaxUrl.delTalk,util.confirm({modal:1,content:util.format(util.lang.index.userBan,e.username),okHandler:function(){$.post(c,e,function(){window.location.reload()})}})),"markread"==b&&(c=a.attr("data-url"),util.confirm({title:"标记已读",modal:1,content:util.lang.index.markread,okHandler:function(){$.post(c,e,function(){window.location.reload()})}})),"blackmanage"==b&&util.showPopup("black-manage",{width:540,modal:!0})}$(".msg-list-item").on("mouseover",function(){$(this).addClass("item-hover")}).on("mouseout",function(){$(this).removeClass("item-hover")}).on("click",function(a){var b=$(this),c=$(a.target);if(c.hasClass("operate")||c.parent().hasClass("operate"));else{b.removeClass("msg-topic-new");var d=b.attr("data-url");d&&(window.location.href=d)}}),$(document).on("click",function(b){var c=$(b.target);if(c.hasClass("operate")||c.parent().hasClass("operate")){var d=c.closest(".msg-item"),e=d.find(".operate-list"),f="true"==e.attr("data-open")?!1:!0;return $(".operate-list").each(function(a,b){$(b).is(e)?e.toggle(f).attr("data-open",f):$(b).attr("data-open",!1).hide()}),!1}$(".operate-list").attr("data-open",0).hide();var g=c.attr("data-command");return g?(a(c,g),!1):void 0}),$(".popup-trigger").on("click",function(){return util.showPopup($(this).attr("data-id"),{title:"写纸条",width:450,modal:!0}),!1}),pageParams.isNew>0&&(util.showPopup("new-msg",{title:"写纸条",width:450,modal:!0}),pageParams.tousername&&$("#add-input").val(pageParams.tousername)),$(".popup .close, .popup .popup-close").on("click",function(){$(this).closest(".popup").hide(),$(".mask").remove()});var b=$(".operation"),c=$(".operation-del"),d=$(".operation-search"),e=$("#msg-form"),f=$(".main .delete-all"),g=f.children("input:checkbox");$("#btn-batch-del").on("click",function(){b.hide(),c.show(),$(".checkbox-list input:checkbox").show(),e.hide()}),$(".btn-del-cancel").on("click",function(){b.show(),c.hide(),$(".checkbox-list input:checkbox").hide(),e.show()}),g.on("click",function(){var a=$(this).prop("checked");g.prop("checked",a),$(".checkbox-list input:checkbox").prop("checked",a)});var h;$("#btn-del-confirm").on("click",function(){h?h.show():h=util.confirm({content:"确认要删除这些对话记录吗？",modal:1,okHandler:function(){var a=$.map($(".checkbox-list input:checked"),function(a){return a.value});if(a.length){var b=pageParams.ajaxUrl.delTalkBatch;$.post(b,{talk_id:a.join(",")},function(){window.location.reload()})}}})}),$("#btn-search").on("click",function(){b.hide(),d.show(),e.hide()}),$("#btn-search-cancel").on("click",function(){b.show(),d.hide(),e.show()})});var util=window.util||{},pageParams=window.pageParams||{},listModule=function(){function a(a){if(d)return!1;var c=j+"&page="+a;d=1,k.load(),$.ajax({url:c,dataType:"json",success:function(a){setTimeout(function(){d=0,0===a.status&&(b(a.data.list||[]),k.success(),a.data.loadend&&(e=1,k.complete()))},1e3)},failure:function(){d=0}})}function b(a){var b=[];$.each(a,function(a,c){c.talkStyle="guest-talk",c.issend&&(c.talkStyle="me-talk"),c.delStyle="hide",f&&(c.delStyle=""),b[a]=util.format(l,c)}),h.append(b.join("")),b.length&&$(".operation-del").removeClass("hide-forever")}function c(){g.on("click",function(){return e?!1:void a(++i)})}var d,e,f,g=$("#talk-msg-load"),h=$("#talk-msg-list"),i=1,j=h.attr("data-url"),k={load:function(){g.attr("data-loading",1).text("加载中...")},success:function(){g.attr("data-loading",0).text("点击加载更多...")},complete:function(){g.addClass("load-more-end").attr("data-loading",0).text("已加载完毕")}},l='<li class="talk-msg-item clear"><fieldset class="date-talk"><legend class="time-title">#{dateline}</legend></fieldset><section class="#{talkStyle} clear"><a class="avatar-talk user-avator" href="#{url}" title="#{username}"><img class="avator-round" src="#{avator}"></a><div class="content-talk"><div class="msg-arrow"><em class="line-c">◆</em><span class="bg-c">◆</span></div><div class="msg-dialog-box"><input type="checkbox" name="deletepm_delid[]" class="checkbox #{delStyle}" value="#{pmid}"><p class="msg-dialog-text">#{content}</p></div></div></section></li>';return{init:function(){h.size()&&c()},setDelMode:function(a){f=a}}}();$(function(){var a;$(".btn-delpm-confirm").on("click",function(){a?a.show():a=util.confirm({content:"确认要删除这些对话记录吗？",modal:1,okHandler:function(){var a=$.map($(".checkbox-list input:checked"),function(a){return a.value});a.length&&$.post(pageParams.ajaxUrl.delMsgBatch,{message_id:a.join(",")},function(){window.location.reload()})}})});var b=$("#chat-sendmsg-form"),c=$("#chat-sendmsg-box").find(".txt"),d=c.parent(),e=$("#form-send-btn");c.on("focusin",function(){d.addClass("msg-textbox-focus"),c.addClass("textarea-expanded"),e.parent().removeClass("hide")}).on("focusout",function(){d.removeClass("msg-textbox-focus")}),e.on("click",function(){var a=b.attr("action"),d=$.trim(c.val());return d?($.ajax({type:"post",url:a,data:{content:d},dataType:"json",success:function(a){a&&0===a.status&&window.location.reload()}}),!1):!1}),listModule.init(),$("#btn-batch-del").on("click",function(){listModule.setDelMode(!0)}),$(".btn-del-cancel").on("click",function(){listModule.setDelMode(!1)});$(".appl")});var userModule=function(){function a(){$("#btn-adduser").on("click",function(){})}{var b={};$(".user-manage")}return b.init=function(){a()},b}();$(function(){userModule.init()});var pageParams=window.pageParams||{},newMsgModule=function(){function a(){h.on("click",function(){if(!c){var a,b=e.find(".tagsinput input"),d=$.trim(b.val());d==b.attr("data-default")&&(d="");var i=f.val(),j=i?i.split(","):[];d&&j.push(d),j.length?e.find(".tagsinput").removeClass("input-invalid"):(e.find(".tagsinput").addClass("input-invalid"),a=1);var k=$.trim(g.val());k?g.removeClass("input-invalid"):(g.addClass("input-invalid"),a=1);var l={user_name:j.join(","),content:k},m=pageParams.ajaxUrl.postMessage;a||(h.text("发送中..."),c=1,$.post(m,l).done(function(){c=0,window.location.reload()}).fail(function(){c=0,h.text("发送")}))}}),g.on("keypress",function(){g.removeClass("input-invalid")})}function b(){var a=$.map(i,function(a){return $(a).text()});f.tagsInput({width:"auto",height:"auto",defaultText:f.attr("placeholder")||"请输入对方用户名",placeholderColor:"#999",onAddTag:function(){e.find(".tagsinput").removeClass("input-invalid")},autocomplete:{source:a,minLength:0,position:{my:"left top+2"}},autocompleteUrl:"#"})}var c,d=$("#new-msg-form"),e=d.find(".inputbox-username"),f=d.find("#add-input"),g=d.find("textarea"),h=d.find("#btn-send"),i=d.find(".suggest-wrap>li");return{init:function(){a(),b()}}}(),blackModule=function(){function a(){e.tagsInput({width:"auto",height:"auto",defaultText:e.attr("placeholder")||"输入用户名",placeholderColor:"#999",onAddTag:function(){d.find(".tagsinput").removeClass("input-invalid")}})}function b(){var a=pageParams.ajaxUrl.banUserBatch;f.on("click",function(){var b=e.val();return b?($.post(a,{user_name:b}).done(function(){e.importTags("")}).fail(function(){}),!1):!1})}var c=$("#black-manage-form"),d=c.find(".inputbox"),e=c.find("#add-black-input"),f=c.find("#add-black-btn"),g={};return g.init=function(){c.size()>0&&(a(),b())},g}();$(function(){newMsgModule.init(),blackModule.init()});