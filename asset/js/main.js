/* zhitiao.94uv.com 2014-10-16 */
function Dialog(a){var b=this,c=b.options=$.extend({title:"提示",width:450,skin:"",ico:""},a),d=b.main=$("<div/>").addClass("popup").addClass("popup-"+c.skin),e=($("<div/>").addClass("popup-title").text(c.title).appendTo(d),$('<a href="javascript:;"><i class="fa fa-times"></i></a>').addClass("close").appendTo(d)),f=$("<div/>").addClass("popup-content").appendTo(d),g=($("<i/>").addClass("popup-ico").addClass(c.ico).appendTo(f),$("<div/>").addClass("popup-text").text(c.content).appendTo(f),b.footer=$("<div/>").addClass("popup-btn").hide().appendTo(d));if(c.buttons&&c.buttons.length&&(g.show(),b.renderBtns(c.buttons)),d.appendTo($(document.body)),c.modal){var h=b.mask=$("<div/>").addClass("mask");$(document.body).append(h),h.on("click",function(){b.hide()})}e.on("click",function(){b.hide()}),b.show()}Dialog.prototype={constructor:Dialog,show:function(){var a=this.main;this.options.modal&&this.mask.css({width:$(window).width()+"px",height:Math.max($(window).height(),$(document.body).outerHeight())+"px"}).show(),a.width(this.options.width).show();var b=($(window).height()-a.outerHeight())/2,c=($(window).width()-a.outerWidth())/2,d=$(window).scrollTop();a.css({left:c+"px",top:b+d+"px"})},hide:function(){this.mask&&this.mask.hide(),this.main.hide()},dispose:function(){this.mask&&this.mask.hide().remove(),this.main.hide().remove(),this.mask=this.main=this.foot=null},renderBtns:function(a){var b=this,c=b.footer;$.each(a,function(a,d){var e=$('<button type="button" />').text(d.text).addClass("btn btn-"+(d.skin||"default")).appendTo(c);e.on("click",function(){d.handler&&d.handler.call(b)})})}};var util=function(){function a(a,b){var c=$("#popup-"+a);if(!c.size())return!1;c.show(),b=$.extend({},b);var d=($(window).height()-c.outerHeight())/2,e=($(window).width()-c.outerWidth())/2;if(c.css({left:e+"px",top:d+"px"}),b.modal){var f=$("<div/>").addClass("mask").css({width:$(window).width()+"px",height:Math.max($(window).height(),$(document.body).outerHeight())+"px"});$(document.body).append(f),f.show(),f.on("click",function(){var a=$(this);c.hide(),a.hide().remove()})}}var b={};b.lang={index:{talkDel:"确认要删除与 #{0} 的对话记录吗？",userBan:"确认要将 #{0} 加入屏蔽用户列表吗？您将收不到对方发来的纸条",markread:"您确定要将所有消息的状态置为已读吗？"},message:{batchDel:"确认要删除这些对话记录吗？"},talk:{userBan:"确认要将 #{0} 加入屏蔽用户列表吗？您将收不到对方发来的纸条"}};var c={confirm:"fa fa-question-circle"};return b.confirm=function(a){var b=$.extend({title:"确认",width:450,fontawesome:1,cancelBtnText:"取消",okBtnText:"确认",skin:"confirm",ico:c.confirm,buttons:[{text:"取消",handler:function(){this.hide()}},{text:"确定",skin:"primary",handler:function(){var b;a.okHandler&&(b=a.okHandler.call(this)),b!==!1&&this.hide()}}]},a),d=new Dialog(b);return d},b.showPopup=a,b.format=function(a,b){a=String(a);var c=Array.prototype.slice.call(arguments,1),d=Object.prototype.toString;return c.length?(c=1==c.length&&null!==b&&/\[object Array\]|\[object Object\]/.test(d.call(b))?b:c,a.replace(/#\{(.+?)\}/g,function(a,b){var e=c[b];return"[object Function]"==d.call(e)&&(e=e(b)),"undefined"==typeof e?"":e})):a},b.parseJSON=function(a){try{return new Function("return ("+a+")")()}catch(b){return{}}},b}(),util=window.util||{},pageParams=window.pageParams||{};$(function(){function a(a,b){var c,d=a.attr("data-value")||"{}",e=util.parseJSON(d);"talkdel"==b&&(c=pageParams.ajaxUrl.banUser,util.confirm({modal:1,content:util.format(util.lang.index.talkDel,e.username),okHandler:function(){$.post(c,e,function(){window.location.reload()})}})),"userban"==b&&(c=pageParams.ajaxUrl.delTalk,util.confirm({modal:1,content:util.format(util.lang.index.userBan,e.username),okHandler:function(){$.post(c,e,function(){window.location.reload()})}})),"markread"==b&&(c=a.attr("data-url"),util.confirm({title:"标记已读",modal:1,content:util.lang.index.markread,okHandler:function(){$.post(c,e,function(){window.location.reload()})}}))}$(".uc-redirect-add").each(function(a,b){var c=encodeURIComponent(window.location.href),d=$(b).attr("href");d+=(d.indexOf("?")>-1?"&":"?")+"redirect_url="+c,$(b).attr("href",d)});var b=$("#scrolltop");$(window).on("scroll",function(){var a=$(window).scrollTop();a>80?b.show():b.hide()}),b.on("click",function(){$(document.body).animate({scrollTop:0})}),$(".msg-list-item").on("mouseover",function(){$(this).addClass("item-hover")}).on("mouseout",function(){$(this).removeClass("item-hover")}).on("click",function(a){var b=$(this),c=$(a.target);if(c.hasClass("operate")||c.parent().hasClass("operate"));else{b.removeClass("msg-topic-new");var d=b.attr("data-url");d&&(window.location.href=d)}}),$(document).on("click",function(b){var c=$(b.target);if(c.hasClass("operate")||c.parent().hasClass("operate")){var d=c.closest(".msg-item"),e=d.find(".operate-list"),f="true"==e.attr("data-open")?!1:!0;return $(".operate-list").each(function(a,b){$(b).is(e)?e.toggle(f).attr("data-open",f):$(b).attr("data-open",!1).hide()}),!1}$(".operate-list").attr("data-open",0).hide();var g=c.attr("data-command");return g?(a(c,g),!1):void 0}),$(".popup-trigger").on("click",function(){return util.showPopup($(this).attr("data-id"),{title:"写纸条",width:440,modal:!0}),!1}),pageParams.isNew>0&&(util.showPopup("new-msg",{title:"写纸条",width:640,modal:!0}),pageParams.tousername&&$("#add-input").val(pageParams.tousername)),$(".popup .close").on("click",function(){$(this).closest(".popup").hide(),$(".mask").remove()});var c=$(".operation"),d=$(".operation-del"),e=$(".operation-search"),f=$("#msg-form"),g=$(".main .delete-all"),h=g.children("input:checkbox");$("#btn-batch-del").on("click",function(){c.hide(),d.show(),$(".checkbox-list input:checkbox").show(),f.hide()}),$(".btn-del-cancel").on("click",function(){c.show(),d.hide(),$(".checkbox-list input:checkbox").hide(),f.show()}),h.on("click",function(){var a=$(this).prop("checked");h.prop("checked",a),$(".checkbox-list input:checkbox").prop("checked",a)});var i;$("#btn-del-confirm").on("click",function(){i?i.show():i=util.confirm({content:"确认要删除这些对话记录吗？",modal:1,okHandler:function(){var a=$.map($(".checkbox-list input:checked"),function(a){return a.value});if(a.length){var b=pageParams.ajaxUrl.delTalkBatch;$.post(b,{data:a},function(){window.location.reload()})}}})}),$("#btn-search").on("click",function(){c.hide(),e.show(),f.hide()}),$("#btn-search-cancel").on("click",function(){c.show(),e.hide(),f.show()})});var newMsgModule=function(){function a(){c.on("click",function(){})}var b=$("#new-msg-form"),c=(b.find(".inputbox-username"),b.find("#add-input"),b.find("textarea"),b.find("#btn-send"));return{init:function(){a()}}}(),util=window.util||{},pageParams=window.pageParams||{},listModule=function(){function a(a){if(d)return!1;var c=j+"&page="+a;d=1,k.load(),$.ajax({url:c,dataType:"json",success:function(a){setTimeout(function(){d=0,0===a.status&&(b(a.data.list||[]),k.success(),a.data.loadend&&(e=1,k.complete()))},1e3)},failure:function(){d=0}})}function b(a){var b=[];$.each(a,function(a,c){c.talkStyle="guest-talk",c.issend&&(c.talkStyle="me-talk"),c.delStyle="hide",f&&(c.delStyle=""),b[a]=util.format(l,c)}),h.append(b.join("")),b.length&&$(".operation-del").removeClass("hide-forever")}function c(){g.on("click",function(){return e?!1:void a(++i)})}var d,e,f,g=$("#talk-msg-load"),h=$("#talk-msg-list"),i=1,j=h.attr("data-url"),k={load:function(){g.attr("data-loading",1).text("加载中...")},success:function(){g.attr("data-loading",0).text("点击加载更多...")},complete:function(){g.addClass("load-more-end").attr("data-loading",0).text("已加载完毕")}},l='<li class="talk-msg-item clear"><fieldset class="date-talk"><legend class="time-title">#{dateline}</legend></fieldset><section class="#{talkStyle} clear"><a class="avatar-talk user-avator" href="#{url}" title="#{username}"><img class="avator-round" src="#{avator}"></a><div class="content-talk"><div class="msg-arrow"><em class="line-c">◆</em><span class="bg-c">◆</span></div><div class="msg-dialog-box"><input type="checkbox" name="deletepm_delid[]" class="checkbox #{delStyle}" value="#{pmid}"><p class="msg-dialog-text">#{content}</p></div></div></section></li>';return{init:function(){h.size()&&c()},setDelMode:function(a){f=a}}}();$(function(){var a;$(".btn-delpm-confirm").on("click",function(){a?a.show():a=util.confirm({content:"确认要删除这些对话记录吗？",modal:1,okHandler:function(){var a=$.map($(".checkbox-list input:checked"),function(a){return a.value});a.length&&$.post(pageParams.ajaxUrl.delMsgBatch,{data:a},function(){window.location.reload()})}})});var b=$("#chat-sendmsg-form"),c=$("#chat-sendmsg-box").find(".txt"),d=c.parent(),e=$("#form-send-btn");c.on("focusin",function(){d.addClass("msg-textbox-focus"),c.addClass("textarea-expanded"),e.parent().removeClass("hide")}).on("focusout",function(){d.removeClass("msg-textbox-focus")}),e.on("click",function(){var a=b.attr("action"),d=$.trim(c.val());return d?($.ajax({type:"post",url:a,data:{content:d},dataType:"json",success:function(a){a&&0===a.status&&window.location.reload()}}),!1):!1}),listModule.init(),$("#btn-batch-del").on("click",function(){listModule.setDelMode(!0)}),$(".btn-del-cancel").on("click",function(){listModule.setDelMode(!1)});$(".appl")});